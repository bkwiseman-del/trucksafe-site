// Trucksafe Platform Database Schema
// Based on README.md architecture
// Last updated: February 2026

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String?   // Hashed password for credentials auth
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // FreshBooks / Billing
  freshbooksClientId    String?   // FreshBooks client ID once linked
  isFreshbooksClient    Boolean   @default(false)
  isBillingOnly         Boolean   @default(false)  // internal FB clients (e.g. staff)
  portalAccess          Boolean   @default(false)  // grants access to /portal

  // Mailchimp
  emailSubscribed       Boolean   @default(true)
  lastActiveAt          DateTime?

  // Relations - Auth
  profile              Profile?
  accounts             Account[]
  sessions             Session[]
  roles                UserRole[]
  badges               UserBadge[]
  privacySettings      PrivacySettings?
  notificationSettings NotificationPreferences?

  // Relations - Subscriptions
  subscription         Subscription?

  // Relations - Network
  posts                Post[]
  comments             Comment[]
  reactions            Reaction[]
  messages             Message[]
  userMedia            UserMedia[]

  // Relations - Content
  articles             Article[]

  // Relations - Events
  eventRegistrations   EventRegistration[]
  bootcampAttendee     BootcampAttendee[]

  // Relations - Client Portal (legacy)
  clientRecord         Client?
  consultingHours      ConsultingHours[]

  // Relations - FreshBooks Billing
  consultingHoursCache ConsultingHoursCache?
  invoiceCache         InvoiceCache[]
  billingHistory       BillingHistory[]
  freshbooksReview     FreshbooksClientReview?

  // Relations - Thinkific
  thinkificUser        ThinkificUser?

  // Relations - Client Portal (new)
  clientPortalConfig   ClientPortalConfig?
  clientDocuments      ClientDocument[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  company   String?
  title     String?
  bio       String?  @db.Text
  phone     String?
  location  String?
  website   String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  role      String   // NETWORK_MEMBER, COMPLIANCE_BASIC, COMPLIANCE_PRO, COMPLIANCE_PREMIUM, CLIENT, TSC_CERTIFIED, BOOTCAMP_ATTENDEE, BOOTCAMP_ALUMNI
  metadata  Json?    // For storing role-specific data (e.g., bootcamp year, certification date)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([userId])
  @@index([role])
}

model Badge {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String
  icon        String   // Emoji or icon identifier
  priority    Int      @default(10) // Lower = higher priority for display
  createdAt   DateTime @default(now())

  userBadges UserBadge[]

  @@index([slug])
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model PrivacySettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  showInDirectory     Boolean  @default(true)
  allowDirectMessages Boolean  @default(true)
  showEmail           Boolean  @default(false)
  showPhone           Boolean  @default(false)
  showCompany         Boolean  @default(true)
  profileVisibility   String   @default("public") // public, members, private
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(true)
  newPostAlerts       Boolean  @default(true)
  newCommentAlerts    Boolean  @default(true)
  directMessageAlerts Boolean  @default(true)
  eventReminders      Boolean  @default(true)
  weeklyDigest        Boolean  @default(true)
  marketingEmails     Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS (COMPLIANCE+)
// ============================================

model SubscriptionTier {
  id                String   @id @default(cuid())
  name              String   @unique // BASIC, PRO, PREMIUM
  displayName       String
  price             Int      // Price in cents
  interval          String   // monthly, yearly
  features          Json     // Array of features
  stripePriceId     String   @unique
  minimumTermMonths Int      @default(0) // 0 = no minimum, 12 = 12-month commitment
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  subscriptions Subscription[]

  @@index([stripePriceId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  tierId               String
  stripeCustomerId     String    @unique
  stripeSubscriptionId String    @unique
  status               String    // active, canceled, past_due, trialing
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  minimumTermEnd       DateTime? // null = no minimum term; date = earliest cancellation allowed
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier SubscriptionTier @relation(fields: [tierId], references: [id])

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

model PaymentHistory {
  id              String   @id @default(cuid())
  userId          String
  stripePaymentId String   @unique
  amount          Int      // Amount in cents
  currency        String   @default("usd")
  status          String   // succeeded, failed, pending
  description     String?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([stripePaymentId])
}

model Invoice {
  id             String    @id @default(cuid())
  userId         String
  freshbooksId   String    @unique
  invoiceNumber  String
  amount         Int       // Amount in cents
  status         String    // draft, sent, viewed, paid, overdue
  dueDate        DateTime
  paidDate       DateTime?
  description    String?   @db.Text
  freshbooksData Json?     // Store full Freshbooks invoice data
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([freshbooksId])
  @@index([status])
}

model ConsultingHours {
  id             String   @id @default(cuid())
  userId         String
  quarterYear    String   // e.g., "2026-Q1"
  hoursAllotted  Float    // 2.0 for Pro, 5.0 for Premium
  hoursUsed      Float    @default(0)
  freshbooksData Json?    // Time entry tracking from Freshbooks
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, quarterYear])
  @@index([userId])
}

// ============================================
// FRESHBOOKS & BILLING INTEGRATION
// Added: February 2026
// ============================================

// Caches FreshBooks time entries bucketed by quarter for consulting hours display
model ConsultingHoursCache {
  id            String   @id @default(cuid())
  userId        String   @unique
  hoursUsedQ1   Float    @default(0)
  hoursUsedQ2   Float    @default(0)
  hoursUsedQ3   Float    @default(0)
  hoursUsedQ4   Float    @default(0)
  currentYear   Int
  lastSyncedAt  DateTime
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])
}

// Caches FreshBooks invoices for the billing portal
model InvoiceCache {
  id                  String    @id @default(cuid())
  userId              String
  freshbooksInvoiceId String    @unique
  invoiceNumber       String
  amount              Float
  currency            String    @default("USD")
  status              String    // draft | sent | viewed | paid | overdue
  dueDate             DateTime?
  paidDate            DateTime?
  description         String?
  freshbooksUrl       String?   // hosted payment URL (requires Advanced Payments)
  lastSyncedAt        DateTime

  user                User      @relation(fields: [userId], references: [id])
}

// Unified billing history from both Stripe and FreshBooks
// Synced nightly — single source of truth for /portal/billing
model BillingHistory {
  id            String    @id @default(cuid())
  userId        String

  // Source tracking (internal only — never exposed to client)
  source        String    // 'stripe' | 'freshbooks'
  sourceId      String    // Stripe payment intent ID or FreshBooks invoice ID

  // Display fields
  category      String    // 'subscription' | 'consulting' | 'shop'
  description   String
  amount        Float
  currency      String    @default("USD")
  status        String    // 'paid' | 'unpaid' | 'overdue' | 'draft' | 'refunded'
  invoiceDate   DateTime
  dueDate       DateTime?
  paidDate      DateTime?

  // Action URLs
  paymentUrl    String?   // FreshBooks payment link (unpaid FB invoices only)
  pdfUrl        String?   // Stripe: invoice_pdf URL | FreshBooks: proxied via our API
  receiptUrl    String?   // Stripe receipt URL (paid Stripe charges)

  lastSyncedAt  DateTime

  user          User      @relation(fields: [userId], references: [id])

  @@unique([source, sourceId])
}

// Admin review queue for FreshBooks clients with no matching platform account
model FreshbooksClientQueue {
  id                  String    @id @default(cuid())
  freshbooksClientId  String    @unique
  freshbooksEmail     String
  freshbooksName      String
  freshbooksCompany   String?
  isBillingOnly       Boolean   @default(false)
  existingUserId      String?
  status              String    @default("pending") // pending | approved | dismissed
  reviewedAt          DateTime?
  reviewedBy          String?
  createdAt           DateTime  @default(now())
}

// Flags ambiguous FreshBooks matches (name match only, no email match)
model FreshbooksClientReview {
  id                    String    @id @default(cuid())
  userId                String    @unique
  suggestedFreshbooksId String
  matchReason           String    // 'name_match'
  matchedName           String
  status                String    @default("pending") // pending | confirmed | dismissed
  reviewedAt            DateTime?
  reviewedBy            String?
  createdAt             DateTime  @default(now())

  user                  User      @relation(fields: [userId], references: [id])
}

// Logs all FreshBooks sync job results for monitoring
model FreshbooksSync {
  id        String   @id @default(cuid())
  userId    String
  syncType  String   // 'hours' | 'invoices' | 'billing_history'
  status    String   // 'success' | 'error'
  error     String?
  syncedAt  DateTime @default(now())
}

// General-purpose admin notification system
model AdminNotification {
  id          String    @id @default(cuid())
  type        String    // 'freshbooks_client_queue' | 'freshbooks_review' | 'sync_failure'
  title       String
  body        String
  linkUrl     String?
  referenceId String?
  status      String    @default("unread") // unread | read | actioned
  emailSent   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  readAt      DateTime?
}

// ============================================
// NETWORK / COMMUNITY FORUMS
// ============================================

model Category {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  order     Int      @default(0)
  createdAt DateTime @default(now())

  forums Forum[]

  @@index([slug])
}

model Forum {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  categoryId  String
  accessLevel String   @default("public") // public, basic, pro, premium, certified, bootcamp
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  posts    Post[]

  @@index([slug])
  @@index([categoryId])
  @@index([accessLevel])
}

model Post {
  id        String   @id @default(cuid())
  authorId  String
  forumId   String
  title     String
  content   String   @db.Text
  pinned    Boolean  @default(false)
  locked    Boolean  @default(false)
  viewCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  forum     Forum      @relation(fields: [forumId], references: [id], onDelete: Cascade)
  comments  Comment[]
  reactions Reaction[]

  @@index([authorId])
  @@index([forumId])
  @@index([createdAt])
  @@index([pinned])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@index([postId])
  @@index([authorId])
  @@index([createdAt])
}

model Reaction {
  id        String   @id @default(cuid())
  type      String   // like, helpful, love
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, type])
  @@unique([userId, commentId, type])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
}

model Conversation {
  id           String   @id @default(cuid())
  participants String[] // Array of user IDs
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  messages Message[]

  @@index([participants])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  content        String   @db.Text
  read           Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model UserMedia {
  id            String    @id @default(cuid())
  userId        String
  filename      String
  fileUrl       String
  fileType      String    // image, video, document
  fileSize      Int       // bytes
  uploadedAt    DateTime  @default(now())
  retentionDate DateTime? // When user-uploaded media will be purged

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([retentionDate])
}

// ============================================
// THINKIFIC ACADEMY INTEGRATION
// Added: February 2026
// ============================================

// Represents anyone who exists in Thinkific, regardless of Trucksafe account
model ThinkificUser {
  id                  String    @id @default(cuid())
  thinkificId         Int       @unique
  email               String    @unique
  firstName           String?
  lastName            String?
  createdInThinkific  DateTime?
  lastSyncedAt        DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Nullable: null until user explicitly links accounts
  trucksafeUserId     String?   @unique
  trucksafeUser       User?     @relation(fields: [trucksafeUserId], references: [id])

  enrollments         ThinkificEnrollment[]
}

model ThinkificEnrollment {
  id                  String    @id @default(cuid())
  thinkificUserId     String
  thinkificEnrollId   Int       @unique
  courseId            Int
  courseName          String
  percentageCompleted Float     @default(0)
  activatedAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  expiryDate          DateTime?
  certificateUrl      String?   // Only populated on enrollment.completed webhook
  freeTrial           Boolean   @default(false)
  lastWebhookAt       DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  thinkificUser       ThinkificUser @relation(fields: [thinkificUserId], references: [id])

  @@index([thinkificUserId])
  @@index([courseId])
}

// ============================================
// CONTENT MANAGEMENT (ARTICLES, LIVE!)
// ============================================

model Article {
  id              String    @id @default(cuid())
  authorId        String
  title           String
  slug            String    @unique
  content         String    @db.Text
  excerpt         String?   @db.Text
  featuredImage   String?
  status          String    @default("draft") // draft, published, scheduled
  publishedAt     DateTime?
  scheduledFor    DateTime?
  metaTitle       String?
  metaDescription String?   @db.Text
  metaKeywords    String?
  viewCount       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  author     User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories ArticleCategory[]
  tags       ArticleTag[]

  @@index([authorId])
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

model ArticleCategory {
  id        String   @id @default(cuid())
  articleId String
  name      String
  slug      String
  createdAt DateTime @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([slug])
}

model ArticleTag {
  id        String   @id @default(cuid())
  articleId String
  name      String
  slug      String
  createdAt DateTime @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([slug])
}

model Video {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  youtubeId       String   @unique
  description     String?  @db.Text
  transcript      String?  @db.Text
  duration        Int?     // seconds
  publishedAt     DateTime
  viewCount       Int      @default(0)
  specialGuests   Json?    // Array of guest objects {name, company, bio, photo}
  showNotesStatus String   @default("pending") // pending, draft, published
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([youtubeId])
  @@index([publishedAt])
}

model Resource {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  fileUrl     String
  fileType    String   // pdf, video, document
  category    String
  accessLevel String   @default("public") // public, basic, pro, premium
  downloads   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([accessLevel])
  @@index([category])
}

// ============================================
// EVENTS & CALENDAR
// ============================================

model Event {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  description     String?   @db.Text
  eventType       String    // webinar, bootcamp, live_show, group_call
  startDate       DateTime
  endDate         DateTime?
  location        String?
  accessLevel     String    @default("public") // public, basic, pro, premium, registered
  maxAttendees    Int?
  registrationUrl String?
  meetingLink     String?
  status          String    @default("upcoming") // upcoming, live, completed, canceled
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  registrations EventRegistration[]

  @@index([slug])
  @@index([eventType])
  @@index([startDate])
  @@index([status])
}

model EventRegistration {
  id           String   @id @default(cuid())
  eventId      String
  userId       String
  status       String   @default("registered") // registered, attended, no_show, canceled
  registeredAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ============================================
// BOOTCAMP
// ============================================

model BootcampEvent {
  id           String   @id @default(cuid())
  title        String
  slug         String   @unique
  description  String?  @db.Text
  startDate    DateTime
  endDate      DateTime
  location     String
  venue        String?
  maxAttendees Int?
  status       String   @default("upcoming") // upcoming, active, completed
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tickets   BootcampTicket[]
  attendees BootcampAttendee[]
  resources BootcampResource[]
  rooms     BootcampRoom[]

  @@index([slug])
  @@index([startDate])
  @@index([status])
}

model BootcampTicket {
  id          String   @id @default(cuid())
  eventId     String
  name        String   // Standard, Pro Member Discount, Premium Member Discount
  price       Int      // Price in cents
  description String?  @db.Text
  quantity    Int?     // null = unlimited
  soldCount   Int      @default(0)
  createdAt   DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model BootcampAttendee {
  id              String   @id @default(cuid())
  eventId         String
  userId          String
  ticketType      String
  amountPaid      Int      // Amount in cents
  stripePaymentId String?
  checkInStatus   String   @default("registered") // registered, checked_in, no_show
  registeredAt    DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model BootcampResource {
  id          String   @id @default(cuid())
  eventId     String
  title       String
  description String?  @db.Text
  fileUrl     String
  fileType    String
  uploadedAt  DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model BootcampRoom {
  id        String   @id @default(cuid())
  eventId   String
  roomName  String
  capacity  Int
  bookings  Json     // Array of booking objects {userId, userName, checkInTime, checkOutTime}
  createdAt DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

// ============================================
// CLIENT PORTAL (LEGACY — kept for compatibility)
// ============================================

model Client {
  id                String    @id @default(cuid())
  userId            String    @unique
  freshbooksId      String    @unique
  companyName       String?
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  agreementSigned   Boolean   @default(false)
  agreementSignedAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  documents ClientDocument_Legacy[]
  messages  ClientMessage[]
  audits    ClientAudit[]
  user      User              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([freshbooksId])
}

model ClientDocument_Legacy {
  id          String   @id @default(cuid())
  clientId    String
  title       String
  description String?  @db.Text
  fileUrl     String
  fileName    String
  fileSize    Int      // bytes
  category    String   // policy, compliance, audit, general
  uploadedBy  String   // user_id or "trucksafe"
  uploadedAt  DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([category])
}

model ClientMessage {
  id       String   @id @default(cuid())
  clientId String
  senderId String   // user_id or "trucksafe"
  subject  String
  content  String   @db.Text
  read     Boolean  @default(false)
  sentAt   DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([sentAt])
}

model ClientAudit {
  id            String    @id @default(cuid())
  clientId      String
  auditType     String    @default("mock_dot") // mock_dot, compliance_review
  status        String    @default("scheduled") // scheduled, in_progress, completed, canceled
  scheduledDate DateTime?
  completedDate DateTime?
  reportUrl     String?
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
}

// ============================================
// CLIENT PORTAL — DROPBOX INTEGRATION
// Added: February 2026
// ============================================

enum SetupStatus {
  NOT_NEEDED
  PENDING
  LINKED
}

enum DocumentDirection {
  OUTBOUND  // Trucksafe → Client (staff placed in Client Portal Docs/)
  INBOUND   // Client → Trucksafe (uploaded via portal, lands in Client Uploads/)
}

model ClientPortalConfig {
  id                  String      @id @default(cuid())
  userId              String      @unique

  // FreshBooks
  freshbooksClientId  String?
  freshbooksStatus    SetupStatus @default(PENDING)

  // Dropbox
  dropboxFolderPath   String?     // e.g. /Trucksafe/Client Documents/ACIG
  dropboxStatus       SetupStatus @default(PENDING)

  // Portal access
  portalAccess        Boolean     @default(false)
  uploadsEnabled      Boolean     @default(false)
  lastSyncedAt        DateTime?

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  user                User        @relation(fields: [userId], references: [id])
  documents           ClientDocument[]
}

model ClientDocument {
  id              String            @id @default(cuid())
  userId          String
  dropboxPath     String            // Full Dropbox path for downloads
  dropboxFileId   String            @unique  // Stable Dropbox ID (survives renames)
  fileName        String
  fileSize        Int?              // Bytes
  mimeType        String?
  direction       DocumentDirection
  seenByClient    Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  user            User              @relation(fields: [userId], references: [id], map: "ClientDocument_user_fkey")
  config          ClientPortalConfig @relation(fields: [userId], references: [userId], map: "ClientDocument_config_fkey")

  @@index([userId])
  @@index([userId, direction])
  @@index([dropboxFileId])
}

// ============================================
// MEDIA LIBRARY (ADMIN)
// ============================================

model Media {
  id           String   @id @default(cuid())
  filename     String
  fileUrl      String
  fileType     String   // image, video, document, audio
  mimeType     String
  fileSize     Int      // bytes
  altText      String?
  caption      String?  @db.Text
  uploadedBy   String   // user_id
  category     String?
  isPersistent Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([fileType])
  @@index([uploadedBy])
  @@index([category])
  @@index([isPersistent])
}
