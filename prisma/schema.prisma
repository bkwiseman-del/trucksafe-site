// Trucksafe Platform Database Schema
// Based on README.md architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String? // Hashed password for credentials auth
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  profile              Profile?
  accounts             Account[]
  sessions             Session[]
  roles                UserRole[]
  badges               UserBadge[]
  subscription         Subscription?
  privacySettings      PrivacySettings?
  notificationSettings NotificationPreferences?
  posts                Post[]
  comments             Comment[]
  reactions            Reaction[]
  messages             Message[]
  articles             Article[]
  eventRegistrations   EventRegistration[]
  bootcampAttendee     BootcampAttendee[]
  clientRecord         Client?                  @relation(fields: [clientId], references: [id])
  consultingHours      ConsultingHours[]
  userMedia            UserMedia[]
  clientId             String?

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  company   String?
  title     String?
  bio       String?  @db.Text
  phone     String?
  location  String?
  website   String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  role      String // NETWORK_MEMBER, COMPLIANCE_BASIC, COMPLIANCE_PRO, COMPLIANCE_PREMIUM, CLIENT, TSC_CERTIFIED, BOOTCAMP_ATTENDEE, BOOTCAMP_ALUMNI
  metadata  Json? // For storing role-specific data (e.g., bootcamp year, certification date)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([userId])
  @@index([role])
}

model Badge {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String
  icon        String // Emoji or icon identifier
  priority    Int      @default(10) // Lower = higher priority for display
  createdAt   DateTime @default(now())

  userBadges UserBadge[]

  @@index([slug])
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model PrivacySettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  showInDirectory     Boolean  @default(true)
  allowDirectMessages Boolean  @default(true)
  showEmail           Boolean  @default(false)
  showPhone           Boolean  @default(false)
  showCompany         Boolean  @default(true)
  profileVisibility   String   @default("public") // public, members, private
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(true)
  newPostAlerts       Boolean  @default(true)
  newCommentAlerts    Boolean  @default(true)
  directMessageAlerts Boolean  @default(true)
  eventReminders      Boolean  @default(true)
  weeklyDigest        Boolean  @default(true)
  marketingEmails     Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS (COMPLIANCE+)
// ============================================

model SubscriptionTier {
  id            String   @id @default(cuid())
  name          String   @unique // BASIC, PRO, PREMIUM
  displayName   String
  price         Int // Price in cents
  interval      String // monthly, yearly
  features      Json // Array of features
  stripePriceId String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]

  @@index([stripePriceId])
}

model Subscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  tierId               String
  stripeCustomerId     String   @unique
  stripeSubscriptionId String   @unique
  status               String // active, canceled, past_due, trialing
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier SubscriptionTier @relation(fields: [tierId], references: [id])

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

model PaymentHistory {
  id              String   @id @default(cuid())
  userId          String
  stripePaymentId String   @unique
  amount          Int // Amount in cents
  currency        String   @default("usd")
  status          String // succeeded, failed, pending
  description     String?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([stripePaymentId])
}

model Invoice {
  id             String    @id @default(cuid())
  userId         String
  freshbooksId   String    @unique
  invoiceNumber  String
  amount         Int // Amount in cents
  status         String // draft, sent, viewed, paid, overdue
  dueDate        DateTime
  paidDate       DateTime?
  description    String?   @db.Text
  freshbooksData Json? // Store full Freshbooks invoice data
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([freshbooksId])
  @@index([status])
}

model ConsultingHours {
  id             String   @id @default(cuid())
  userId         String
  quarterYear    String // e.g., "2026-Q1"
  hoursAllotted  Float // 2.0 for Pro, 5.0 for Premium
  hoursUsed      Float    @default(0)
  freshbooksData Json? // Time entry tracking from Freshbooks
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, quarterYear])
  @@index([userId])
}

// ============================================
// NETWORK / COMMUNITY FORUMS
// ============================================

model Category {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  order     Int      @default(0)
  createdAt DateTime @default(now())

  forums Forum[]

  @@index([slug])
}

model Forum {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  categoryId  String
  accessLevel String   @default("public") // public, basic, pro, premium, certified, bootcamp
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  posts    Post[]

  @@index([slug])
  @@index([categoryId])
  @@index([accessLevel])
}

model Post {
  id        String   @id @default(cuid())
  authorId  String
  forumId   String
  title     String
  content   String   @db.Text
  pinned    Boolean  @default(false)
  locked    Boolean  @default(false)
  viewCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  forum     Forum      @relation(fields: [forumId], references: [id], onDelete: Cascade)
  comments  Comment[]
  reactions Reaction[]

  @@index([authorId])
  @@index([forumId])
  @@index([createdAt])
  @@index([pinned])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@index([postId])
  @@index([authorId])
  @@index([createdAt])
}

model Reaction {
  id        String   @id @default(cuid())
  type      String // like, helpful, love
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, type])
  @@unique([userId, commentId, type])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
}

model Conversation {
  id           String   @id @default(cuid())
  participants String[] // Array of user IDs
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  messages Message[]

  @@index([participants])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  content        String   @db.Text
  read           Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model UserMedia {
  id            String    @id @default(cuid())
  userId        String
  filename      String
  fileUrl       String
  fileType      String // image, video, document
  fileSize      Int // bytes
  uploadedAt    DateTime  @default(now())
  retentionDate DateTime? // When user-uploaded media will be purged

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([retentionDate])
}

// ============================================
// CONTENT MANAGEMENT (ARTICLES, LIVE!)
// ============================================

model Article {
  id              String    @id @default(cuid())
  authorId        String
  title           String
  slug            String    @unique
  content         String    @db.Text
  excerpt         String?   @db.Text
  featuredImage   String?
  status          String    @default("draft") // draft, published, scheduled
  publishedAt     DateTime?
  scheduledFor    DateTime?
  metaTitle       String?
  metaDescription String?   @db.Text
  metaKeywords    String?
  viewCount       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  author     User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories ArticleCategory[]
  tags       ArticleTag[]

  @@index([authorId])
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

model ArticleCategory {
  id        String   @id @default(cuid())
  articleId String
  name      String
  slug      String
  createdAt DateTime @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([slug])
}

model ArticleTag {
  id        String   @id @default(cuid())
  articleId String
  name      String
  slug      String
  createdAt DateTime @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([slug])
}

model Video {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  youtubeId       String   @unique
  description     String?  @db.Text
  transcript      String?  @db.Text
  duration        Int? // seconds
  publishedAt     DateTime
  viewCount       Int      @default(0)
  specialGuests   Json? // Array of guest objects {name, company, bio, photo}
  showNotesStatus String   @default("pending") // pending, draft, published
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([youtubeId])
  @@index([publishedAt])
}

model Resource {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  fileUrl     String
  fileType    String // pdf, video, document
  category    String
  accessLevel String   @default("public") // public, basic, pro, premium
  downloads   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([accessLevel])
  @@index([category])
}

// ============================================
// EVENTS & CALENDAR
// ============================================

model Event {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  description     String?   @db.Text
  eventType       String // webinar, bootcamp, live_show, group_call
  startDate       DateTime
  endDate         DateTime?
  location        String? // Virtual, physical address, or URL
  accessLevel     String    @default("public") // public, basic, pro, premium, registered
  maxAttendees    Int?
  registrationUrl String?
  meetingLink     String?
  status          String    @default("upcoming") // upcoming, live, completed, canceled
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  registrations EventRegistration[]

  @@index([slug])
  @@index([eventType])
  @@index([startDate])
  @@index([status])
}

model EventRegistration {
  id           String   @id @default(cuid())
  eventId      String
  userId       String
  status       String   @default("registered") // registered, attended, no_show, canceled
  registeredAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ============================================
// BOOTCAMP
// ============================================

model BootcampEvent {
  id           String   @id @default(cuid())
  title        String
  slug         String   @unique
  description  String?  @db.Text
  startDate    DateTime
  endDate      DateTime
  location     String
  venue        String?
  maxAttendees Int?
  status       String   @default("upcoming") // upcoming, active, completed
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tickets   BootcampTicket[]
  attendees BootcampAttendee[]
  resources BootcampResource[]
  rooms     BootcampRoom[]

  @@index([slug])
  @@index([startDate])
  @@index([status])
}

model BootcampTicket {
  id          String   @id @default(cuid())
  eventId     String
  name        String // Standard, Pro Member Discount, Premium Member Discount
  price       Int // Price in cents
  description String?  @db.Text
  quantity    Int? // null = unlimited
  soldCount   Int      @default(0)
  createdAt   DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model BootcampAttendee {
  id              String   @id @default(cuid())
  eventId         String
  userId          String
  ticketType      String
  amountPaid      Int // Amount in cents
  stripePaymentId String?
  checkInStatus   String   @default("registered") // registered, checked_in, no_show
  registeredAt    DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model BootcampResource {
  id          String   @id @default(cuid())
  eventId     String
  title       String
  description String?  @db.Text
  fileUrl     String
  fileType    String
  uploadedAt  DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model BootcampRoom {
  id        String   @id @default(cuid())
  eventId   String
  roomName  String
  capacity  Int
  bookings  Json // Array of booking objects {userId, userName, checkInTime, checkOutTime}
  createdAt DateTime @default(now())

  event BootcampEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

// ============================================
// CLIENT PORTAL
// ============================================

model Client {
  id                String    @id @default(cuid())
  userId            String    @unique
  freshbooksId      String    @unique
  companyName       String?
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  agreementSigned   Boolean   @default(false)
  agreementSignedAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  documents ClientDocument[]
  messages  ClientMessage[]
  audits    ClientAudit[]
  User      User[]

  @@index([userId])
  @@index([freshbooksId])
}

model ClientDocument {
  id          String   @id @default(cuid())
  clientId    String
  title       String
  description String?  @db.Text
  fileUrl     String
  fileName    String
  fileSize    Int // bytes
  category    String // policy, compliance, audit, general
  uploadedBy  String // user_id or "trucksafe"
  uploadedAt  DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([category])
}

model ClientMessage {
  id       String   @id @default(cuid())
  clientId String
  senderId String // user_id or "trucksafe"
  subject  String
  content  String   @db.Text
  read     Boolean  @default(false)
  sentAt   DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([sentAt])
}

model ClientAudit {
  id            String    @id @default(cuid())
  clientId      String
  auditType     String    @default("mock_dot") // mock_dot, compliance_review
  status        String    @default("scheduled") // scheduled, in_progress, completed, canceled
  scheduledDate DateTime?
  completedDate DateTime?
  reportUrl     String?
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
}

// ============================================
// MEDIA LIBRARY (ADMIN)
// ============================================

model Media {
  id           String   @id @default(cuid())
  filename     String
  fileUrl      String
  fileType     String // image, video, document, audio
  mimeType     String
  fileSize     Int // bytes
  altText      String?
  caption      String?  @db.Text
  uploadedBy   String // user_id
  category     String?
  isPersistent Boolean  @default(false) // Trucksafe-uploaded = true, user-uploaded = false
  createdAt    DateTime @default(now())

  @@index([fileType])
  @@index([uploadedBy])
  @@index([category])
  @@index([isPersistent])
}
